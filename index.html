<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reexport statistika</title>
<style>
:root{
  --bg:#0e0f13; --card:#151822; --muted:#8b90a1; --text:#e9ecf1; --accent:#6ee7b7; --accent-2:#60a5fa; --danger:#ef4444;
  --radius:12px;
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);}
.app{display:flex;flex-wrap:wrap;padding:20px;gap:20px;}
.card{background:var(--card);padding:16px;border-radius:var(--radius);flex:1 1 320px;min-width:300px;}
.card h2{margin-top:0;}
input,select,button{width:100%;padding:8px;margin:4px 0;border-radius:6px;border:1px solid #333;background:#101321;color:var(--text);}
button{cursor:pointer;}
.btn-accent{background:var(--accent);color:#000;border:none;}
.btn-danger{background:var(--danger);color:#000;border:none;}
.kpi{margin:8px 0;padding:8px;border:1px solid #222;border-radius:8px;background:#111629;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #222;padding:6px;text-align:left;}
</style>
</head>
<body>
<div class="app">
  <!-- LEVA KOLONA -->
  <div class="card">
    <h2>Unos reexporta</h2>
    <label>Datum</label><input type="date" id="datumReexport">
    <label>Šifra</label><input type="text" id="sifra" placeholder="npr. 4213">
    <label>Razlog</label>
    <select id="razlog">
      <option>Ugovor</option>
      <option>Slike</option>
      <option>Checkbox</option>
    </select>
    <label>Agent</label>
    <select id="agent">
      <option>Jovan</option>
      <option>Marija</option>
      <option>Tijana</option>
    </select>
    <button class="btn-accent" id="sacuvajReexport">Sačuvaj reexport</button>
    <div id="statusReexport"></div>
  </div>

  <div class="card">
    <h2>Unos realizovanih terena</h2>
    <label>Datum</label><input type="date" id="datumRealizovan">
    <label>Agent</label>
    <select id="agentRealizovan">
      <option>Jovan</option>
      <option>Marija</option>
      <option>Tijana</option>
    </select>
    <label>Broj terena</label><input type="number" id="brojTeren" min="1" placeholder="npr. 5">
    <button class="btn-accent" id="sacuvajRealizovan">Sačuvaj realizovane</button>
    <div id="statusRealizovan"></div>
  </div>

  <div class="card">
    <h2>Ukupan broj unetih stanova</h2>
    <input type="number" id="ukupnoStanova" placeholder="npr. 120" min="0">
    <button class="btn-accent" id="sacuvajUkupno">Sačuvaj broj</button>
    <div id="statusUkupno"></div>
  </div>

  <!-- DESNA KOLONA -->
  <div class="card" style="flex:2 1 600px;">
    <h2>Statistika</h2>
    <label>Filter datum od–do:</label>
    <input type="date" id="filterOd"> do <input type="date" id="filterDo">
    <button class="btn-accent" id="primeniFilter">Primeni filter</button>

    <div class="kpi">Ukupno reexporta: <span id="kpiUkupno">0</span></div>
    <div class="kpi">Ugovor: <span id="kpiUgovor">0</span></div>
    <div class="kpi">Slike: <span id="kpiSlike">0</span></div>
    <div class="kpi">Checkbox: <span id="kpiCheckbox">0</span></div>
    <div class="kpi">Po agentu: <span id="poAgentu">—</span></div>
    <div class="kpi">Procenat reexporta: <span id="procenatReexporta">—</span></div>
    <div class="kpi">Realizovani tereni: <span id="realizacijaAgent">—</span></div>

    <h3>Detalji</h3>
    <table>
      <thead>
        <tr><th>Datum</th><th>Šifra</th><th>Razlog</th><th>Agent</th><th>Broj terena</th><th>Akcija</th></tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAOUkVLeBTltH6MdNoK74kkP-cEYAMHjc4",
  authDomain: "statistika-d3977.firebaseapp.com",
  projectId: "statistika-d3977",
  storageBucket: "statistika-d3977.firebasestorage.app",
  messagingSenderId: "243287759147",
  appId: "1:243287759147:web:23b0abd5f4e3bdbe2e8d6e"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const collReexport=db.collection('reexporti');
const collRealizovan=db.collection('realizovaniTereni');
const collUkupno=db.collection('ukupnoStanova');

// elementi
const datumReexport=document.getElementById('datumReexport');
const sifra=document.getElementById('sifra');
const razlog=document.getElementById('razlog');
const agent=document.getElementById('agent');
const sacuvajReexport=document.getElementById('sacuvajReexport');
const statusReexport=document.getElementById('statusReexport');

const datumRealizovan=document.getElementById('datumRealizovan');
const agentRealizovan=document.getElementById('agentRealizovan');
const brojTeren=document.getElementById('brojTeren');
const sacuvajRealizovan=document.getElementById('sacuvajRealizovan');
const statusRealizovan=document.getElementById('statusRealizovan');

const ukupnoStanova=document.getElementById('ukupnoStanova');
const sacuvajUkupno=document.getElementById('sacuvajUkupno');
const statusUkupno=document.getElementById('statusUkupno');

const kpiUkupno=document.getElementById('kpiUkupno');
const kpiUgovor=document.getElementById('kpiUgovor');
const kpiSlike=document.getElementById('kpiSlike');
const kpiCheckbox=document.getElementById('kpiCheckbox');
const poAgentu=document.getElementById('poAgentu');
const procenatReexporta=document.getElementById('procenatReexporta');
const realizacijaAgent=document.getElementById('realizacijaAgent');
const tabela=document.getElementById('tabela');

const filterOd=document.getElementById('filterOd');
const filterDo=document.getElementById('filterDo');
const primeniFilter=document.getElementById('primeniFilter');

const agents=['Jovan','Marija','Tijana'];
const today=new Date().toISOString().slice(0,10);
datumReexport.value=datumRealizovan.value=today;

// UCITAJ I PRIKAZI
async function ucitajIPrikazi(){
  const snapR=await collReexport.orderBy('createdAt','desc').get();
  const snapT=await collRealizovan.orderBy('createdAt','desc').get();
  const snapU=await collUkupno.orderBy('createdAt','desc').limit(1).get();
  if(!ukupnoStanova.value && !snapU.empty) ukupnoStanova.value=snapU.docs[0].data().broj;

  let reexporti=snapR.docs.map(d=>({id:d.id,...d.data()}));
  let tereni=snapT.docs.map(d=>({id:d.id,...d.data()}));

  // filter po datumu
  if(filterOd.value && filterDo.value){
    const from=new Date(filterOd.value);
    const to=new Date(filterDo.value);
    reexporti=reexporti.filter(x=>{ const d=new Date(x.datum); return d>=from && d<=to; });
    tereni=tereni.filter(x=>{ const d=new Date(x.datum); return d>=from && d<=to; });
  }

  // tabela
  tabela.innerHTML='';
  for(const r of reexporti){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.datum}</td><td>${r.sifra}</td><td>${r.razlog}</td><td>${r.agent}</td><td>—</td>
      <td><button class="btn-danger" onclick="obrisi('reexporti','${r.id}')">Obriši</button></td>`;
    tabela.appendChild(tr);
  }
  for(const t of tereni){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.datum}</td><td>—</td><td>Realizovan teren</td><td>${t.agent}</td><td>${t.broj}</td>
      <td><button class="btn-danger" onclick="obrisi('realizovaniTereni','${t.id}')">Obriši</button></td>`;
    tabela.appendChild(tr);
  }

  // statistika
  const total=reexporti.length;
  kpiUkupno.textContent=total;
  kpiUgovor.textContent=reexporti.filter(x=>x.razlog==='Ugovor').length;
  kpiSlike.textContent=reexporti.filter(x=>x.razlog==='Slike').length;
  kpiCheckbox.textContent=reexporti.filter(x=>x.razlog==='Checkbox').length;

  const counts=Object.fromEntries(agents.map(a=>[a,0]));
  for(const r of reexporti)if(counts[r.agent]!==undefined)counts[r.agent]++;
  poAgentu.textContent=agents.map(a=>`${a}: ${counts[a]}`).join(' • ');

  const ukupno=parseInt(ukupnoStanova.value||'0',10);
  procenatReexporta.textContent=ukupno>0 ? ((total/ukupno)*100).toFixed(1)+'%' : '—';

  const realCounts=Object.fromEntries(agents.map(a=>[a,0]));
  for(const t of tereni)if(realCounts[t.agent]!==undefined)realCounts[t.agent]+=t.broj;
  realizacijaAgent.textContent=agents.map(a=>`${a}: ${realCounts[a]} terena`).join(' • ');
}

// SACUVAJ REEXPORT
sacuvajReexport.addEventListener('click',async()=>{
  if(!sifra.value.trim()){ statusReexport.textContent='Unesi šifru!'; return; }
  await collReexport.add({
    datum:datumReexport.value,
    sifra:sifra.value.trim(),
    razlog:razlog.value,
    agent:agent.value,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  statusReexport.textContent='Sačuvano ✓';
  setTimeout(()=>statusReexport.textContent='',2000);
  sifra.value='';
  ucitajIPrikazi();
});

// SACUVAJ REALIZOVANE
sacuvajRealizovan.addEventListener('click',async()=>{
  if(!brojTeren.value || brojTeren.value<1){ statusRealizovan.textContent='Unesi broj terena!'; return; }
  await collRealizovan.add({
    datum:datumRealizovan.value,
    agent:agentRealizovan.value,
    broj:parseInt(brojTeren.value),
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  statusRealizovan.textContent='Sačuvano ✓';
  setTimeout(()=>statusRealizovan.textContent='',2000);
  brojTeren.value='';
  ucitajIPrikazi();
});

// SACUVAJ UKUPNO STANOVA
sacuvajUkupno.addEventListener('click',async()=>{
  if(!ukupnoStanova.value || ukupnoStanova.value<0){ statusUkupno.textContent='Unesi broj!'; return; }
  await collUkupno.add({
    broj:parseInt(ukupnoStanova.value),
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  statusUkupno.textContent='Sačuvano ✓';
  setTimeout(()=>statusUkupno.textContent='',2000);
  ucitajIPrikazi();
});

// FILTER
primeniFilter.addEventListener('click', ucitajIPrikazi);

// OBRISI
window.obrisi=async(collection,id)=>{
  if(confirm('Da li želiš da obrišeš ovaj zapis?')){
    await db.collection(collection).doc(id).delete();
    ucitajIPrikazi();
  }
};

// inicijalno ucitavanje
ucitajIPrikazi();
</script>
</body>
</html>
